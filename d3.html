<!doctype html>

<meta charset="utf-8">
<title>工作流程图</title>

<script src="https://d3js.org/d3.v4.js"></script>
<script src="Content/plugins/jQuery/jQuery-2.1.4.min.js"></script>
<script src="Designer/demo/dist/dagre-d3.js"></script>
<link rel="stylesheet" href="Designer/demo/tipsy.css">
<script src="Designer/demo/tipsy.js"></script>

<style id="css">
h1 {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serf;
  margin-top: 0.8em;
  margin-bottom: 0.2em;
}

text {
  font-weight: 300;
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serf;
  font-size: 14px;
}

.node rect {
  stroke: #333;
  fill: #fff;
  stroke-width: 1.5px;
}

.node polygon {
  stroke: #333;
  fill: #fff;
  stroke-width: 1.5px;
}

.edgePath path.path {
  stroke: #333;
  fill: none;
  stroke-width: 1.5px;
}

div#top-frame {
  height: 350px;
}

div#WBS-frame {
  float: left;
  width: 50%;
}

div#dependencies-frame {
  float: left;
  width: 50%;
}

div#schedule-frame {
  float: none;
}
</style>

<script>
var dagred3Story = function(svgelement) {
	this.g = new dagreD3.graphlib.Graph().setGraph({});
	this.g.setDefaultEdgeLabel(function() { return {}; });
    this.g.graph().marginx = 10;
    this.g.graph().marginy = 10;
	this.g.graph().rankdir = "LR";
	this.g.graph().ranksep = 20;
	this.g.graph().nodesep = 20;
	this.svg = d3.select(svgelement);
    this.inner = this.svg.append("g");
    this.dagreD3render = new dagreD3.render();
};

dagred3Story.prototype.createProcess=function(data,sy)
{
	    var getId=function(tagName){
	      var Node=father.getElementsByTagName(tagName);//("fpdl:StartNode");
	      var Id=$(Node).attr("Id");
          //console.log(Id);
          return Id;
	    }
        var father=$(data)[0].firstElementChild;
        var FrameArry=new Array();
        //添加开始/结束
        var StartNode=["setRadiusNode",getId("fpdl:StartNode"),"开始"];
        var EndNode=["setRadiusNode",getId("fpdl:EndNode"),"结束"];
        FrameArry.push(StartNode);
        FrameArry.push(EndNode);
        //添加同步器
        var syarry=[];
        if(sy){
           var Synchronizer=father.getElementsByTagName('fpdl:Synchronizer');
           $.each(Synchronizer,function(n,i) {
               var Id=$(i).attr("Id");
               syarry.push(["setSynchronizer",Id])
               FrameArry.push(["setSynchronizer",Id]);
            });
        }
        //添加任务
        var Activity=father.getElementsByTagName('fpdl:Activity');
         $.each(Activity,function(n,i) {
            var Id=$(i).attr("Id");
            var DisplayName=$(i).attr("DisplayName");
            var ext=$(this.getElementsByTagName("fpdl:ExtendedAttribute"));
            var name=$(ext[ext.length-1]).attr("Name");
            var setFlag=name=="decision"?"setMilestone":"setActivity";
            FrameArry.push([setFlag,Id,DisplayName]);
        });
        //添加流程
        var Transition=father.getElementsByTagName('fpdl:Transition');
        var f,t;
         $.each(Transition,function(n,i) {
            var From=$(i).attr("From");
            var To=$(i).attr("To");
            var DisplayName=$(i).attr("DisplayName");
            if(!sy) {
                if (To.indexOf("Synchronizer") > -1) {
                    f = From;
                }
                else if (From.indexOf("Synchronizer") > -1) {
                    From = f;
                    FrameArry.push(["AddDependencyEdge",From,To,DisplayName]);
                }else
                {
                    FrameArry.push(["AddDependencyEdge",From,To,DisplayName]);
                }
            }else {
                FrameArry.push(["AddDependencyEdge", From, To, DisplayName]);
            }
        });
        return FrameArry;
}

dagred3Story.prototype.initStory=function(Story){
    var index = 0,name,obj=this;
    switch(index)
    {
    	case 0:
    	name="LoanProcess"
    	break;
    	case 1:
    	name="Goods_Deliver_Process"
    	break;
    }
    $.get("Designer/"+name+".xml",function(data){
        console.log(data);
        var frame=obj.createProcess(data,false);
        obj.initFrame1(frame);
    });
   //this.initFrame(Story[index]);
}

dagred3Story.prototype.initFrame1 = function(Frame) {
		Frame.forEach(function(x) {
			switch(x[0]) {
				case 'removeNode':
					this.g.removeNode(x[1])
					break;
				case 'setActivity':
					this.g.setNode(x[1],{label:x[2]})
					break;
				case 'setRadiusNode':
					this.g.setNode(x[1],{label:x[2],rx:10,ry:10,shape: 'rect',style: "fill: #fff; stroke: #000;" });
				    break;
				case 'setMilestone':
					this.g.setNode(x[1],{label:x[2],shape: 'diamond', style: "fill: #fff; stroke: #000" })
					break;
				case 'setSynchronizer':
					this.g.setNode(x[1],{label:'S',shape: 'circle', style: "fill: #fff; stroke: #000" })
					break;
				case 'AddCoherenceEdge':
					this.g.setEdge(x[1], x[2], {
						curve: d3.curveBasis
						,arrowheadStyle: "fill: #333" 
					});
					break;
				case 'AddDependencyEdge':
					this.g.setEdge(x[1], x[2], {
						curve: d3.curveBasis
						,label: x[3]
						,labeloffset: 5
						,labelpos: 'l'
					});
					break;
				default:
					console.log ("Schedule Network element "+x+" is not implemented")
				}
		}.bind(this))
		
		if (this.g) {
			this.dagreD3render(this.inner,this.g);
			var inner=this.inner;
			//缩放
            var zoom = d3.zoom().on("zoom", function() {inner.attr("transform", d3.event.transform);});
            this.svg.call(zoom);
			//悬浮提示框
			this.inner.selectAll("g.node").attr("title", function(v) { return '34234324' }).each(
				function(v) { 
					$(this).tipsy({ gravity: "w", opacity: 1, html: true }); 
				});
			//居中
			var initialScale = 1;
            this.svg.call(zoom.transform, d3.zoomIdentity.translate((this.svg.attr("width") - this.g.graph().width * initialScale) / 2, 20).scale(initialScale));
            this.svg.attr('height', this.g.graph().height * initialScale + 40);
		}
};

dagred3Story.prototype.initFrame = function(Frame) {
		Frame.forEach(function(x) {
			switch(x[0]) {
				case 'setActivity':
					this.g.setNode(x[1],{})
					break;
				case 'setRadiusNode':
					this.g.setNode(x[1],{rx:10,ry:10,shape: 'rect',style: "fill: #fff; stroke: #000;" });
				    break;
				case 'setMilestone':
					this.g.setNode(x[1],{label:x[1],shape: 'diamond', style: "fill: #fff; stroke: #000" })
					break;
				case 'AddCoherenceEdge':
					this.g.setEdge(x[1], x[2], {
						curve: d3.curveBasis
						,arrowheadStyle: "fill: #333" 
					});
					break;
				case 'AddDependencyEdge':
					this.g.setEdge(x[1], x[2], {
						curve: d3.curveBasis
						,label: x[3]
						,labeloffset: 5
						,labelpos: 'l'
					});
					break;
				default:
					console.log ("Schedule Network element "+x+" is not implemented")
				}
		}.bind(this))
		
		if (this.g) {
			this.dagreD3render(this.inner,this.g);
			var inner=this.inner;
			//缩放
            var zoom = d3.zoom().on("zoom", function() {inner.attr("transform", d3.event.transform);});
            this.svg.call(zoom);
			//悬浮提示框
			this.inner.selectAll("g.node").attr("title", function(v) { 
				return '34234324';
			}).each(
				function(v) { 
					$(this).tipsy({ gravity: "w", opacity: 1, html: true }); 
				});
			//居中
			var initialScale = 1;
            this.svg.call(zoom.transform, d3.zoomIdentity.translate((this.svg.attr("width") - this.g.graph().width * initialScale) / 2, 20).scale(initialScale));
            this.svg.attr('height', this.g.graph().height * initialScale + 40);
		}
};

</script>

<div id="schedule-frame">
  <svg id="schedule" width=1000 style="border: 1px solid #000;"></svg>
</div>

<script id="js">
var framedelay = 2000;
var schedulestory = new dagred3Story("#schedule");
schedulestory.initStory(
	[
	   [
	     ["setRadiusNode", "开始"]
		 , 
		 ["setRadiusNode", "结束"]
		 ,
		 ["setMilestone", "风险检查"]
		 ,
		 ["setMilestone", "审批"]
		 ,
		 ["setActivity", "提交申请"]
		 ,
		 ["setActivity", "拒绝"]
		 ,
		 ["setActivity", "放贷"]
		 ,
		 ["AddCoherenceEdge", "开始", "提交申请"]
		 ,
		 ["AddCoherenceEdge", "提交申请", "风险检查"]
		 ,
		 ["AddCoherenceEdge", "拒绝", "结束"]
		 ,
		 ["AddCoherenceEdge", "放贷", "结束"]
		  ,
		 ["AddDependencyEdge", "风险检查", "审批","通过"],
		 ,
		 ["AddDependencyEdge", "风险检查", "拒绝","拒绝"]
		  ,
		 ["AddDependencyEdge", "审批", "拒绝","拒绝"],
		 ,
		 ["AddDependencyEdge", "审批", "放贷","通过"]
	   ],
	    [
	     ["setRadiusNode", "开始"]
		 , 
		 ["setRadiusNode", "结束"]
		 ,
		 ["setActivity", "客户付款"]
		 ,
		 ["setActivity", "仓库备货"]
		 ,
		 ["setActivity", "送货员送货"]
		 ,
		 ["setActivity", "发手机短信通知客户收货"]
		 ,
		 ["AddCoherenceEdge", "开始", "客户付款"]
		 ,
		 ["AddCoherenceEdge", "客户付款", "仓库备货"]
		 ,
		 ["AddCoherenceEdge", "仓库备货", "送货员送货"]
		  ,
		 ["AddCoherenceEdge", "仓库备货", "发手机短信通知客户收货"]
		 ,
		 ["AddCoherenceEdge", "送货员送货", "结束"]
		 ,
		 ["AddCoherenceEdge", "发手机短信通知客户收货", "结束"]
	   ]
	]);
</script>
</body>
</html>
